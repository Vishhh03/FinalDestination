<app-navbar></app-navbar>

<div class="hotel-detail-container">
  @if (error()) {
    <div class="alert alert-error">
      <i class="fas fa-exclamation-circle"></i> {{ error() }}
      <button class="alert-close" (click)="error.set('')">&times;</button>
    </div>
  }
  
  @if (success()) {
    <div class="alert alert-success">
      <i class="fas fa-check-circle"></i> {{ success() }}
      <button class="alert-close" (click)="success.set('')">&times;</button>
    </div>
  }
  
  @if (loading()) {
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading hotel details...</p>
    </div>
  }
  
  @if (hotel(); as hotelData) {
    <div class="hotel-header">
      <h1>{{ hotelData.name }}</h1>
      <div class="hotel-location">
        <i class="fas fa-map-marker-alt"></i>
        <span>{{ hotelData.city }}, {{ hotelData.address }}</span>
      </div>
      <div class="hotel-rating">
        <i class="fas fa-star"></i>
        <span>{{ hotelData.rating.toFixed(1) }} / 5.0</span>
      </div>
    </div>
    
    <div class="hotel-content">
      <div class="hotel-info-card">
        <h2>Hotel Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Price per Night</span>
            <span class="info-value">${{ hotelData.pricePerNight.toFixed(2) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Available Rooms</span>
            <span class="info-value">{{ hotelData.availableRooms }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">City</span>
            <span class="info-value">{{ hotelData.city }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Rating</span>
            <span class="info-value">{{ hotelData.rating.toFixed(1) }} ⭐</span>
          </div>
        </div>
      </div>
      
      <div class="booking-card">
        <h2>Book Your Stay</h2>
        <button class="btn-book" (click)="openBookingModal()">
          <i class="fas fa-calendar-check"></i> Book Now
        </button>
      </div>
    </div>
    
    <div class="reviews-section">
      <div class="reviews-header">
        <h2>Guest Reviews ({{ reviews().length }})</h2>
        @if (reviews().length > 0) {
          <div class="average-rating">
            <i class="fas fa-star"></i>
            <span>{{ getAverageRating().toFixed(1) }} Average</span>
          </div>
        }
      </div>
      
      @if (auth.isAuthenticated()) {
        <div class="review-form">
          <h3>Write a Review</h3>
          <form (ngSubmit)="submitReview()">
            <div class="form-group">
              <label>Rating *</label>
              <select 
                [(ngModel)]="rating"
                name="rating"
                class="form-control">
                <option [value]="5">⭐⭐⭐⭐⭐ Excellent</option>
                <option [value]="4">⭐⭐⭐⭐ Very Good</option>
                <option [value]="3">⭐⭐⭐ Good</option>
                <option [value]="2">⭐⭐ Fair</option>
                <option [value]="1">⭐ Poor</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Comment *</label>
              <textarea 
                [(ngModel)]="comment"
                name="comment"
                class="form-control"
                rows="4" 
                placeholder="Share your experience (minimum 10 characters)..."
                required></textarea>
              <small class="hint">{{ comment.length }} / 1000 characters</small>
            </div>
            
            <button type="submit" class="btn-primary" [disabled]="submittingReview()">
              @if (submittingReview()) {
                <i class="fas fa-spinner fa-spin"></i> Submitting...
              } @else {
                <i class="fas fa-paper-plane"></i> Submit Review
              }
            </button>
          </form>
        </div>
      } @else {
        <div class="login-prompt">
          <i class="fas fa-info-circle"></i>
          <p>Please <a routerLink="/login">login</a> to write a review</p>
        </div>
      }
      
      <div class="reviews-list">
        @for (review of reviews(); track review.id) {
          <div class="review-card">
            <div class="review-header">
              <div class="reviewer-info">
                <i class="fas fa-user-circle"></i>
                <span class="review-author">{{ review.userName }}</span>
              </div>
              <div class="review-rating">
                @for (star of getRatingStars(review.rating); track $index) {
                  @if (star === 'full') {
                    <i class="fas fa-star"></i>
                  } @else if (star === 'half') {
                    <i class="fas fa-star-half-alt"></i>
                  } @else {
                    <i class="far fa-star"></i>
                  }
                }
              </div>
            </div>
            <p class="review-date">{{ review.createdAt | date:'medium' }}</p>
            <p class="review-comment">{{ review.comment }}</p>
          </div>
        }
        
        @if (reviews().length === 0) {
          <div class="no-reviews">
            <i class="fas fa-comments"></i>
            <p>No reviews yet. Be the first to review!</p>
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- Booking Modal -->
@if (showBookingModal()) {
<div class="modal-overlay" (click)="closeBookingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Complete Your Booking</h2>
      <button class="modal-close" (click)="closeBookingModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      @if (error()) {
        <div class="alert alert-error">
          <i class="fas fa-exclamation-circle"></i> {{ error() }}
        </div>
      }
      
      <form (ngSubmit)="bookHotel()">
        <div class="form-group">
          <label for="checkInDate">Check-in Date *</label>
          <input 
            type="date" 
            id="checkInDate"
            [(ngModel)]="checkInDate"
            name="checkInDate"
            class="form-control"
            [min]="today"
            required
          />
        </div>
        
        <div class="form-group">
          <label for="checkOutDate">Check-out Date *</label>
          <input 
            type="date" 
            id="checkOutDate"
            [(ngModel)]="checkOutDate"
            name="checkOutDate"
            class="form-control"
            [min]="checkInDate || tomorrow"
            required
          />
        </div>
        
        <div class="form-group">
          <label for="numberOfGuests">Number of Guests *</label>
          <input 
            type="number" 
            id="numberOfGuests"
            [(ngModel)]="numberOfGuests"
            name="numberOfGuests"
            class="form-control"
            min="1" 
            max="10"
            required
          />
        </div>
        
        @if (availablePoints() > 0) {
          <div class="loyalty-section">
            <div class="loyalty-header">
              <span><i class="fas fa-gift"></i> Redeem Loyalty Points</span>
              <span class="points-available">{{ availablePoints() }} points available</span>
            </div>
            <div class="form-group">
              <label for="pointsToRedeem">Points to Redeem (100 points = $1)</label>
              <input 
                type="number" 
                id="pointsToRedeem"
                [(ngModel)]="pointsToRedeem"
                name="pointsToRedeem"
                class="form-control"
                min="0"
                [max]="maxRedeemablePoints()"
                step="100"
              />
              <small class="hint">Maximum {{ maxRedeemablePoints() }} points (50% of total)</small>
            </div>
          </div>
        }
        
        @if (nights() > 0) {
          <div class="booking-summary">
            <h3>Booking Summary</h3>
            <div class="summary-row">
              <span>{{ nights() }} night(s) × ${{ hotel()!.pricePerNight.toFixed(2) }}</span>
              <strong>${{ totalAmount().toFixed(2) }}</strong>
            </div>
            @if (discount() > 0) {
              <div class="summary-row">
                <span>Loyalty Discount ({{ pointsToRedeem }} points)</span>
                <strong class="discount">-${{ discount().toFixed(2) }}</strong>
              </div>
            }
            <div class="summary-row total">
              <span>Total Amount</span>
              <strong>${{ finalAmount().toFixed(2) }}</strong>
            </div>
          </div>
        }
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeBookingModal()" [disabled]="submittingBooking()">
            Cancel
          </button>
          <button type="submit" class="btn-primary" [disabled]="submittingBooking()">
            @if (submittingBooking()) {
              <i class="fas fa-spinner fa-spin"></i> Processing...
            } @else {
              <i class="fas fa-check"></i> Confirm Booking
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}
