<app-navbar></app-navbar>

<div class="hotel-detail-container">
  @if (error()) {
    <div class="alert alert-error">
      <i class="fas fa-exclamation-circle"></i> {{ error() }}
      <button class="alert-close" (click)="error.set('')">&times;</button>
    </div>
  }
  
  @if (success()) {
    <div class="alert alert-success">
      <i class="fas fa-check-circle"></i> {{ success() }}
      <button class="alert-close" (click)="success.set('')">&times;</button>
    </div>
  }
  
  @if (loading()) {
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading hotel details...</p>
    </div>
  }
  
  @if (hotel(); as hotelData) {
    <div class="hotel-header">
      <h1>{{ hotelData.name }}</h1>
      <div class="hotel-location">
        <i class="fas fa-map-marker-alt"></i>
        <span>{{ hotelData.city }}, {{ hotelData.address }}</span>
      </div>
      <div class="hotel-rating">
        <i class="fas fa-star"></i>
        <span>{{ hotelData.rating.toFixed(1) }} / 5.0</span>
      </div>
    </div>

    @if (hotelData.imageUrl) {
      <div class="hotel-main-image">
        <img [src]="hotelData.imageUrl" [alt]="hotelData.name" />
      </div>
    }
    
    <div class="hotel-content">
      <div class="hotel-info-card">
        <h2>Hotel Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Price per Night</span>
            <span class="info-value">₹{{ hotelData.pricePerNight.toFixed(2) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Available Rooms</span>
            <span class="info-value">{{ hotelData.availableRooms }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">City</span>
            <span class="info-value">{{ hotelData.city }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Rating</span>
            <span class="info-value">{{ hotelData.rating.toFixed(1) }} ⭐</span>
          </div>
        </div>
      </div>
      
      <div class="booking-card">
        <h2>Book Your Stay</h2>
        <button class="btn-book" (click)="openBookingModal()">
          <i class="fas fa-calendar-check"></i> Book Now
        </button>
      </div>
    </div>
    
    <div class="reviews-section">
      <div class="reviews-header">
        <h2>Guest Reviews ({{ reviews().length }})</h2>
        @if (reviews().length > 0) {
          <div class="average-rating">
            <i class="fas fa-star"></i>
            <span>{{ getAverageRating().toFixed(1) }} Average</span>
          </div>
        }
      </div>
      
      @if (auth.isAuthenticated()) {
        @if (canReview() || editingReviewId()) {
          <div class="review-form">
            <h3>{{ editingReviewId() ? 'Edit Your Review' : 'Write a Review' }}</h3>
            @if (editingReviewId()) {
              <div class="editing-notice">
                <i class="fas fa-info-circle"></i>
                <span>You are editing your review</span>
                <button type="button" class="btn-cancel-edit" (click)="cancelEdit()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            }
            <form (ngSubmit)="submitReview()">
              <div class="form-group">
                <label>Rating *</label>
                <select 
                  [(ngModel)]="rating"
                  name="rating"
                  class="form-control">
                  <option [value]="5">⭐⭐⭐⭐⭐ Excellent</option>
                  <option [value]="4">⭐⭐⭐⭐ Very Good</option>
                  <option [value]="3">⭐⭐⭐ Good</option>
                  <option [value]="2">⭐⭐ Fair</option>
                  <option [value]="1">⭐ Poor</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Comment *</label>
                <textarea 
                  [(ngModel)]="comment"
                  name="comment"
                  class="form-control"
                  rows="4" 
                  placeholder="Share your experience (minimum 10 characters)..."
                  required></textarea>
                <small class="hint">{{ comment.length }} / 1000 characters</small>
              </div>
              
              <button type="submit" class="btn-primary" [disabled]="submittingReview()">
                @if (submittingReview()) {
                  <i class="fas fa-spinner fa-spin"></i> {{ editingReviewId() ? 'Updating...' : 'Submitting...' }}
                } @else {
                  <i class="fas fa-paper-plane"></i> {{ editingReviewId() ? 'Update Review' : 'Submit Review' }}
                }
              </button>
            </form>
          </div>
        } @else {
          <div class="login-prompt">
            <i class="fas fa-info-circle"></i>
            <p>You can only review hotels where you have completed a paid booking</p>
          </div>
        }
      } @else {
        <div class="login-prompt">
          <i class="fas fa-info-circle"></i>
          <p>Please <a routerLink="/login">login</a> to write a review</p>
        </div>
      }
      
      <div class="reviews-list">
        @for (review of reviews(); track review.id) {
          <div class="review-card">
            <div class="review-header">
              <div class="reviewer-info">
                <i class="fas fa-user-circle"></i>
                <span class="review-author">{{ review.userName }}</span>
              </div>
              <div class="review-actions">
                <div class="review-rating">
                  @for (star of getRatingStars(review.rating); track $index) {
                    @if (star === 'full') {
                      <i class="fas fa-star"></i>
                    } @else if (star === 'half') {
                      <i class="fas fa-star-half-alt"></i>
                    } @else {
                      <i class="far fa-star"></i>
                    }
                  }
                </div>
                @if (auth.isAuthenticated()) {
                  <div class="review-buttons">
                    @if (canEditReview(review)) {
                      <button class="btn-icon btn-edit" (click)="editReview(review)" title="Edit review">
                        <i class="fas fa-edit"></i>
                      </button>
                    }
                    @if (canDeleteReview(review)) {
                      <button class="btn-icon btn-delete" (click)="confirmDeleteReview(review.id)" title="Delete review">
                        <i class="fas fa-trash"></i>
                      </button>
                    }
                  </div>
                }
              </div>
            </div>
            <p class="review-date">{{ review.createdAt | date:'medium' }}</p>
            <p class="review-comment">{{ review.comment }}</p>
          </div>
        }
        
        @if (reviews().length === 0) {
          <div class="no-reviews">
            <i class="fas fa-comments"></i>
            <p>No reviews yet. Be the first to review!</p>
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- Booking Modal -->
@if (showBookingModal()) {
<div class="modal-overlay" (click)="closeBookingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Complete Your Booking</h2>
      <button class="modal-close" (click)="closeBookingModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      @if (error()) {
        <div class="alert alert-error">
          <i class="fas fa-exclamation-circle"></i> {{ error() }}
        </div>
      }
      
      <form (ngSubmit)="bookHotel()">
        @if (auth.hasAnyRole(['Admin', 'HotelManager'])) {
          <div class="guest-booking-toggle">
            <label class="toggle-label">
              <input 
                type="checkbox" 
                [(ngModel)]="isBookingForGuest"
                name="isBookingForGuest"
                (change)="toggleBookingForGuest()"
              />
              <span>Book for another guest</span>
            </label>
          </div>
        }

        @if (isBookingForGuest() || auth.hasAnyRole(['Admin', 'HotelManager'])) {
          <div class="guest-info-section">
            <h4><i class="fas fa-user"></i> Guest Information</h4>
            <div class="form-group">
              <label for="guestName">Guest Name *</label>
              <input 
                type="text" 
                id="guestName"
                [(ngModel)]="guestName"
                name="guestName"
                class="form-control"
                placeholder="Enter guest's full name"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="guestEmail">Guest Email *</label>
              <input 
                type="email" 
                id="guestEmail"
                [(ngModel)]="guestEmail"
                name="guestEmail"
                class="form-control"
                placeholder="Enter guest's email address"
                required
              />
            </div>
          </div>
        }

        <div class="form-group">
          <label for="checkInDate">Check-in Date *</label>
          <input 
            type="date" 
            id="checkInDate"
            [ngModel]="checkInDate()"
            (ngModelChange)="checkInDate.set($event); onCheckInChange()"
            name="checkInDate"
            class="form-control"
            [min]="today"
            required
          />
          <small class="hint">Select today or any future date</small>
        </div>
        
        <div class="form-group">
          <label for="checkOutDate">Check-out Date *</label>
          <input 
            type="date" 
            id="checkOutDate"
            [(ngModel)]="checkOutDate"
            name="checkOutDate"
            class="form-control"
            [min]="minCheckOutDate()"
            [disabled]="!checkInDate()"
            required
          />
          @if (checkInDate()) {
            <small class="hint">Minimum checkout: {{ minCheckOutDateDisplay() }} (1 day after check-in)</small>
          } @else {
            <small class="hint">Please select check-in date first</small>
          }
        </div>
        
        <div class="form-group">
          <label for="numberOfGuests">Number of Guests *</label>
          <input 
            type="number" 
            id="numberOfGuests"
            [(ngModel)]="numberOfGuests"
            name="numberOfGuests"
            class="form-control"
            min="1" 
            max="10"
            required
          />
        </div>
        
        @if (availablePoints() > 0) {
          <div class="loyalty-section">
            <div class="loyalty-header">
              <span><i class="fas fa-gift"></i> Redeem Loyalty Points</span>
              <span class="points-available">{{ availablePoints() }} points available</span>
            </div>
            <div class="form-group">
              <label for="pointsToRedeem">Points to Redeem (1 point = ₹1)</label>
              <input 
                type="number" 
                id="pointsToRedeem"
                [(ngModel)]="pointsToRedeem"
                name="pointsToRedeem"
                class="form-control"
                min="0"
                [max]="maxRedeemablePoints()"
                step="1"
              />
              @if (maxRedeemablePoints() > 0) {
                <small class="hint">Maximum {{ maxRedeemablePoints() }} points (50% of total)</small>
              } @else {
                <small class="hint">Booking total too low to redeem points</small>
              }
            </div>
          </div>
        }
        
        @if (nights() > 0) {
          <div class="booking-summary">
            <h3>Booking Summary</h3>
            <div class="summary-row">
              <span>{{ nights() }} night(s) × ₹{{ hotel()!.pricePerNight.toFixed(2) }}</span>
              <strong>₹{{ totalAmount().toFixed(2) }}</strong>
            </div>
            @if (discount() > 0) {
              <div class="summary-row">
                <span>Loyalty Discount ({{ pointsToRedeem }} points)</span>
                <strong class="discount">-₹{{ discount().toFixed(2) }}</strong>
              </div>
            }
            <div class="summary-row total">
              <span>Total Amount</span>
              <strong>₹{{ finalAmount().toFixed(2) }}</strong>
            </div>
          </div>
        }
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeBookingModal()" [disabled]="submittingBooking()">
            Cancel
          </button>
          <button type="submit" class="btn-primary" [disabled]="submittingBooking()">
            @if (submittingBooking()) {
              <i class="fas fa-spinner fa-spin"></i> Processing...
            } @else {
              <i class="fas fa-check"></i> Confirm Booking
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}


<!-- Delete Review Confirmation Modal -->
@if (showDeleteModal()) {
<div class="modal-overlay" (click)="cancelDeleteReview()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="modal-close" (click)="cancelDeleteReview()">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="warning-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p>Are you sure you want to delete this review?</p>
      <p class="warning-text">This action cannot be undone.</p>
    </div>
    
    <div class="modal-actions">
      <button class="btn-secondary" (click)="cancelDeleteReview()">Cancel</button>
      <button class="btn-danger" (click)="deleteReview()">
        <i class="fas fa-trash"></i> Delete Review
      </button>
    </div>
  </div>
</div>
}
