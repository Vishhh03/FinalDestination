<app-navbar></app-navbar>

<div class="page-header">
    <div class="container">
        <h1>My Bookings</h1>
        <p>Manage your hotel reservations</p>
    </div>
</div>

<section class="bookings-section">
    <div class="container">
        @if (error()) {
        <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i> {{ error() }}
            <button class="alert-close" (click)="error.set('')">&times;</button>
        </div>
        }

        @if (success()) {
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ success() }}
            <button class="alert-close" (click)="success.set('')">&times;</button>
        </div>
        }

        @if (loading() && bookings().length === 0) {
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading your bookings...</p>
        </div>
        }

        <div class="bookings-list">
            @for (booking of bookings(); track booking.id) {
            <div class="booking-card">
                <div class="booking-header">
                    <div>
                        <h3>{{ booking.hotelName }}</h3>
                        <span class="booking-id">Booking #{{ booking.id }}</span>
                    </div>
                    <span class="booking-status" [ngClass]="getStatusClass(booking.status)">
                        {{ getStatusText(booking.status) }}
                    </span>
                </div>
                
                <div class="booking-details">
                    <div class="detail-row">
                        <div class="detail-item">
                            <i class="fas fa-calendar-check"></i>
                            <div>
                                <span class="detail-label">Check-in</span>
                                <span class="detail-value">{{ booking.checkInDate | date:'mediumDate' }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar-times"></i>
                            <div>
                                <span class="detail-label">Check-out</span>
                                <span class="detail-value">{{ booking.checkOutDate | date:'mediumDate' }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <span class="detail-label">Guests</span>
                                <span class="detail-value">{{ booking.numberOfGuests }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <span class="detail-label">Guest Name</span>
                                <span class="detail-value">{{ booking.guestName }}</span>
                            </div>
                        </div>
                    </div>

                    @if (booking.loyaltyPointsRedeemed && booking.loyaltyDiscountAmount) {
                    <div class="loyalty-info">
                        <i class="fas fa-gift"></i>
                        <span>{{ booking.loyaltyPointsRedeemed }} points redeemed for ${{ booking.loyaltyDiscountAmount.toFixed(2) }} discount</span>
                    </div>
                    }

                    @if (booking.loyaltyPointsEarned) {
                    <div class="loyalty-info earned">
                        <i class="fas fa-star"></i>
                        <span>Earned {{ booking.loyaltyPointsEarned }} loyalty points</span>
                    </div>
                    }

                    <div class="booking-total">
                        <span class="total-label">Total Amount:</span>
                        <span class="total-value">${{ booking.totalAmount.toFixed(2) }}</span>
                    </div>
                </div>
                
                <div class="booking-actions">
                    @if (booking.paymentRequired && booking.status === BookingStatus.Confirmed) {
                    <button (click)="openPaymentModal(booking)" class="btn-pay">
                        <i class="fas fa-credit-card"></i> Pay Now
                    </button>
                    }
                    
                    @if (booking.paymentId && booking.status === BookingStatus.Confirmed) {
                    <span class="payment-badge">
                        <i class="fas fa-check-circle"></i> Paid
                    </span>
                    }
                    
                    @if (booking.status === BookingStatus.Confirmed) {
                    <button (click)="cancelBooking(booking)" class="btn-cancel">
                        <i class="fas fa-times"></i> Cancel Booking
                    </button>
                    }
                </div>
            </div>
            }
        </div>

        @if (bookings().length === 0 && !loading()) {
        <div class="no-bookings">
            <i class="fas fa-calendar-alt"></i>
            <p>You don't have any bookings yet</p>
            <a routerLink="/hotels" class="btn-primary">Browse Hotels</a>
        </div>
        }
    </div>
</section>

<!-- Payment Modal -->
@if (showPaymentModal()) {
<div class="modal-overlay" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Payment Details</h2>
            <button class="modal-close" (click)="closePaymentModal()">&times;</button>
        </div>

        @if (selectedBooking()) {
        <div class="modal-body">
            <div class="booking-summary">
                <h3>Booking Summary</h3>
                <div class="summary-item">
                    <span>Hotel:</span>
                    <strong>{{ selectedBooking()!.hotelName }}</strong>
                </div>
                <div class="summary-item">
                    <span>Check-in:</span>
                    <strong>{{ selectedBooking()!.checkInDate | date:'mediumDate' }}</strong>
                </div>
                <div class="summary-item">
                    <span>Check-out:</span>
                    <strong>{{ selectedBooking()!.checkOutDate | date:'mediumDate' }}</strong>
                </div>
                <div class="summary-item total">
                    <span>Total Amount:</span>
                    <strong>${{ selectedBooking()!.totalAmount.toFixed(2) }}</strong>
                </div>
            </div>

            @if (error()) {
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> {{ error() }}
            </div>
            }

            <form [formGroup]="paymentForm" (ngSubmit)="processPayment()">
                <div class="form-group">
                    <label for="paymentMethod">Payment Method *</label>
                    <select id="paymentMethod" formControlName="paymentMethod" class="form-control">
                        <option [value]="PaymentMethod.CreditCard">Credit Card</option>
                        <option [value]="PaymentMethod.DebitCard">Debit Card</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cardHolderName">Card Holder Name *</label>
                    <input 
                        type="text" 
                        id="cardHolderName" 
                        formControlName="cardHolderName"
                        class="form-control"
                        [class.error]="paymentForm.get('cardHolderName')?.touched && paymentForm.get('cardHolderName')?.invalid"
                        placeholder="John Doe"
                    />
                    @if (getFieldError('cardHolderName')) {
                    <span class="error-message">{{ getFieldError('cardHolderName') }}</span>
                    }
                </div>

                <div class="form-group">
                    <label for="cardNumber">Card Number *</label>
                    <input 
                        type="text" 
                        id="cardNumber" 
                        formControlName="cardNumber"
                        class="form-control"
                        [class.error]="paymentForm.get('cardNumber')?.touched && paymentForm.get('cardNumber')?.invalid"
                        placeholder="1234567890123456"
                        maxlength="16"
                        (input)="onCardNumberInput($event)"
                    />
                    @if (getFieldError('cardNumber')) {
                    <span class="error-message">{{ getFieldError('cardNumber') }}</span>
                    }
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expiryMonth">Expiry Month *</label>
                        <input 
                            type="text" 
                            id="expiryMonth" 
                            formControlName="expiryMonth"
                            class="form-control"
                            [class.error]="paymentForm.get('expiryMonth')?.touched && paymentForm.get('expiryMonth')?.invalid"
                            placeholder="MM"
                            maxlength="2"
                        />
                        @if (getFieldError('expiryMonth')) {
                        <span class="error-message">{{ getFieldError('expiryMonth') }}</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="expiryYear">Expiry Year *</label>
                        <input 
                            type="text" 
                            id="expiryYear" 
                            formControlName="expiryYear"
                            class="form-control"
                            [class.error]="paymentForm.get('expiryYear')?.touched && paymentForm.get('expiryYear')?.invalid"
                            placeholder="YY"
                            maxlength="2"
                        />
                        @if (getFieldError('expiryYear')) {
                        <span class="error-message">{{ getFieldError('expiryYear') }}</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="cvv">CVV *</label>
                        <input 
                            type="text" 
                            id="cvv" 
                            formControlName="cvv"
                            class="form-control"
                            [class.error]="paymentForm.get('cvv')?.touched && paymentForm.get('cvv')?.invalid"
                            placeholder="123"
                            maxlength="4"
                        />
                        @if (getFieldError('cvv')) {
                        <span class="error-message">{{ getFieldError('cvv') }}</span>
                        }
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="closePaymentModal()" [disabled]="processingPayment()">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" [disabled]="processingPayment()">
                        @if (processingPayment()) {
                        <i class="fas fa-spinner fa-spin"></i> Processing...
                        } @else {
                        <i class="fas fa-lock"></i> Pay ${{ selectedBooking()!.totalAmount.toFixed(2) }}
                        }
                    </button>
                </div>
            </form>
        </div>
        }
    </div>
</div>
}
